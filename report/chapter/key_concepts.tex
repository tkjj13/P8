\chapter{Receiver structure}

\section{Basic receiver structure}
\label{basic_rev_struct}
A basic general receiver structure can be seen on \autoref{fig:basic_receiver_structure}. It consists of the most common blocks in a receiver, because of the block form it is possible to separate and analyse each block individually. 

\begin{figure}[H]
\centering
\includegraphics[width= \textwidth]{figures/Receiver.pdf}
\caption{A basic receiver structure.}
\label{fig:basic_receiver_structure}
\end{figure}

Each block will analysed with focus on the properties that could influence measurements on the fading gain i.e. gain, noise, distortion etc.

\todo{find sources for all of this}
\textbf{Antenna}\\
When the signal $s(\theta,\phi,t)$ reaches the antenna, the antenna pattern influences the received signal. This can be expressed as:
\begin{equation}
s(t) = \int_0^{2\pi} \! \int_0^\pi G_{ant}(\theta,\phi)\cdot s(\theta,\phi,t) \,\text{d}\phi \,\text{d}\theta
\end{equation} 
\begin{where}
\va{$s(t)$}{is the received signal at the antenna}{W}
\va{$s(\theta,\phi,t)$}{is the signal strength in the $(\theta,\phi)$ direction}{W}
\va{$G_{ant}(\theta,\phi)$}{is the gain in the $(\theta,\phi)$ direction}{1}
\va{$\theta$}{is the azimuth angle}{rad}
\va{$\phi$}{is the elevation}{rad}
\end{where}

It might be possible to use this to gain a extra dimension in the measurement setup, however it might also be a problem as the assumptions for the Doppler spectrum and often relies on omnidirectional reception. Normally it is possible to calibrate the system to account for gain to find the actual signal level, however it is not possible to account for an imbalance in the antenna pattern. 


Impedance mismatch typically occur where the signal is fed from the antenna to the rest of the system, this can be formulated as:

\begin{align}
%x_V(t) = (1+\Gamma)\cdot s_V(t) \\
%x_I(t) = (1-\Gamma)\cdot s_I(t) \\
x_P(t) = (1-\Gamma^2)\cdot s(t) \label{eq:ref_power}
\end{align}
\begin{where}
\va{$x_P(t)$}{is the power transmitted through to the system}{W}
\va{$\Gamma$}{is the reflection coefficient}{1}
\end{where}

This typically introduces both a gain and a phase distortion, however with calibration this is not an issue.

\textbf{\Gls{LNA}}\\
When the signal is passed through the LNA it can be described as:

\begin{equation}
x_{LNA}(t) = G_{LNA}\left(x_P(t)\right)*x_P(t)
\end{equation}
\begin{where}
\va{$x_{LNA}(t)$}{is the outputed signal from the LNA}{W}
\va{$G_{LNA}\left(x_P(t)\right)$}{is the gain of the LNA}{1}
\end{where}

If the signal conforms to $|x_P(t)| < sat$ where sat is the saturation limit of the LNA, $G_{LNA}\left(x_P(t)\right)$ becomes a constant and the convolution becomes a multiplication, however if the power level reaches the saturation level then this is not the case and the complicated convolution is necessary. It is further not easy to calibrate for the distortion introduced by saturating the LNA.
\todo{is distortion part of this?}

\textbf{\Gls{BP}}\\
When the siganl is passed through a BP filter it can be described as
\begin{equation}
%x_{BP}(t) = H_{BP}(t)*\left(G_{LNA}\left(x_P(t)\right)*x_P(t)\right)
x_{BP}(t) = H_{BP}(t)*x_{LNA}
\end{equation}
\begin{where}
\va{$x_{BP}(t)$}{is the signal outputted from the BP filter}{W}
\va{$H_{BP}(t)$}{is the impulse response of the BP filter}{1}
\end{where}

Implications of the BP is the signal becomes band limited which helps reduce noise, however for the filter to work it needs to settle and it also introduces a group delay. The settle time is often between $\frac{1}{f_c}$ and $\frac{3}{f_c}$%http://www.freqdev.com/guide/analog.html
but is highly dependent on the actual order of the filter. The group delay is however not easy to correct, it is therefore desirable to a linear phase shift through the filter as that introduces a constant delay to all frequencies, however in practice this is not case. 


\textbf{Mixer}\\
The mixer is the the only component that relies on its non-linearities in the chain. It takes two input namely the data caring signal and the mixing signal from the \gls{LO} a it can be modelled as:
\begin{equation}
%x_{Mixer}(t) = \left(H_{BP}(t)*\left(G_{LNA}\left(x_P(t)\right)*x_P(t)\right)\right)\cdot sin\left(2\pi\cdot (f_{LO}+\epsilon_{drift}(t)) \cdot t\right)
x_{Mixer}(t) = x_{BP}(t) \cdot sin\left(2\pi\cdot (f_{LO}+\epsilon_{drift}(t)) \cdot t\right)
\end{equation}
\begin{where}
\va{$x_{Mixer}(t)$}{is the output from the mixer}{W}
\va{$f_{LO}$}{is the frequency of the LO}{Hz}
\va{$\epsilon_{drift}(t)$}{is the drift in frequency of the LO}{Hz}
\end{where}
\todo{problem with time dependency?}

Most of the distortion in the processed signal comes from this component, as the process is highly non-linear. The $\epsilon_{drift}(t)$ is often quite small and as long as it does not change the signal to conflict with the LP then it can typically be neglected for all intents and purposes. However a lot of extra frequency components is added to the signal due to the nature of the mixer.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% DO STUFF WITH THIS

%A filter needs approximately $\frac{1}{2\cdot fd_{max}}$\todo{find source (right now found from patricks mail} seconds to settle. This means a measurement should run for at least that amount of time, also the saturation can be avoided by lowering the transmit power. The frequency drift of a oscillator is typically $\pm 50ppm$ \todo{source, link is here} %$http://dk.farnell.com/webapp/wcs/stores/servlet/Search?catalogId=15001&langId=45&storeId=10157&categoryId=700000058502&pageSize=25&showResults=true$}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\textbf{\Gls{LP}}\\
The LP filter make sure that most of the unwanted components introduced from the mixer gets reduced significantly. It is modelled in much the same manner as the BP filter and comes with the same problems. 
\begin{equation}
%x_{LP}(t) = H_{LP}(t)*\left(\left(H_{BP}(t)*\left(G_{LNA}\left(x_P(t)\right)*x_P(t)\right)\right)\cdot \left(f_{LO}+\epsilon_{drift}(t)\right)\right)
x_{LP}(t) = H_{LP}(t)*x_{Mixer}
\end{equation}
\begin{where}
\va{$x_{LP}(t)$}{is the outputted from the LP filter}{W}
\va{$H_{LP}(t)$}{is the impulse response of the LP filter}{1}
\end{where}

The settle time of the LP is often magnitudes longer than the settle time of the BP as the frequencies involved are much lower. 

After this the \gls{ADC} quantise and digitalize the signal so a \gls{PU} can process it. Going through this analysis different parameters affects the signal in the receiver, ending in a rather complicated expression. It can however be seen that there are three different types of problems. 


%\begin{minipage}{0.48\textwidth}
%\begin{itemize}
%\item \textbf{Antenna}
%	\begin{itemize}
%	\item Emission pattern
%	\item Effective gain
%	\item Reflection
%	\end{itemize}
%\end{itemize}
%\end{minipage}
%\begin{minipage}{0.48\textwidth}
%\begin{itemize}
%\item \textbf{\Gls{LNA}}
%	\begin{itemize}
%	\item Gain
%	\item Noise factor
%	\item Distortion
%	\item Saturation
%	\end{itemize}
%\end{itemize}
%\end{minipage}
%\begin{minipage}{0.48\textwidth}
%\begin{itemize}
%\item \textbf{\Gls{BP}}
%	\begin{itemize}
%	\item Phase delay/group delay
%	\item Settle time
%	\item Noise factor
%	\item Bandwidth
%	\end{itemize}	
%\end{itemize}
%\end{minipage}
%\begin{minipage}{0.48\textwidth}
%\begin{itemize}
%\item \textbf{Mixer}
%	\begin{itemize}
%	\item Non-linearities
%	\item Noise factor	
%	\end{itemize}
%\end{itemize}
%\end{minipage}
%\begin{minipage}{0.48\textwidth}
%\begin{itemize}
%\item \textbf{\Gls{LO}}
%	\begin{itemize}
%	\item Drift
%		\end{itemize}
%\end{itemize}
%\end{minipage}
%\begin{minipage}{0.48\textwidth}
%\begin{itemize}
%\item \textbf{\Gls{LP}}
%	\begin{itemize}
%	\item Phase delay/group delay
%	\item Settle time
%	\item Noise factor
%	\end{itemize}
%\end{itemize}
%\end{minipage}
%\begin{minipage}{0.48\textwidth}
%\begin{itemize}
%\item \textbf{\Gls{ADC}}
%	\begin{itemize}
%	\item Quantisation noise
%	\item Effective number of bits
%	\item Conversion time
%	\end{itemize}
%\end{itemize}
%\end{minipage}
%\begin{minipage}{0.48\textwidth}
%\begin{itemize}
%\item \textbf{\Gls{PU}}
%	\begin{itemize}
%	 \item No direct problems
%	\end{itemize}
%\end{itemize}
%\end{minipage}


%These problems can be categorized into what can be accounted for during the measurement, what can be accounted for by calibrating the equipment and what can not be easily dealt with.
%
\begin{itemize}
\item Avoidable problems
	\begin{itemize}
	\item Settle time
	\item Saturation
	\end{itemize}
\item Calibration problems
	\begin{itemize}
	\item Reflection
	\item Gains
	\end{itemize}
\item Distortion problems
	\begin{itemize}	
	\item Phase shift/ group delay
	\item Drift
	\item Non-linearities
	%\item Effective number of bits
	\end{itemize}
%\item Statistical problems
%	\begin{itemize}
%	\item Noise
%	\item Quantization noise
%	\end{itemize}
\end{itemize}
%
%Parameters that is critical to the measurements is the BW and the antenna pattern as these two directly influence the measurement of the channel. The rest only has indirect implications on the measurements. This is supported by related work in \citep{MeasurementComplexRay}

\todo{Some conclusion about noise being more dominant!!!}

\section{Dynamic range}
Dynamic range in RF systems is the ability of the receiver to pick out weak signals compared to the strong ones(the range of the low signals to the high signals which the receiver can operate). Think about it as trying to hear a person talking when somebody in the room is screaming.  
With manual or automatic gain control,the total dynamic range of the receiver will allow it to accept a wider range of signal power.That isn't a problem as long as we want to observe the strongest signal or nearly the strongest one.The situation gets tricky when we want to observe a really weak signal in the presence of much stronger ones.That is the point where we are more interested in the instantaneous dynamic range.
The instantaneous dynamic range is specified as the difference between the strongest to the weakest signal(in dB) that can be present in a receiver's pass band while the receiver is meeting full specified performance in receiving and processing the weaker signal.
The maximum strength that a receiving system can accept and process depends on the sensitivity of the receiver and it's dynamic range.
\begin{equation}
MAXstr_{dBm} = (Sens) +(DR)
\label{Max strength of a receiving system}
\end{equation}

Where MAXstr is the maximum strength of a receiving system,Sens is the sensitivity of the receiver and DR the dynamic range of the system.\citep{DyR}

Receiver sensitivity is defined as the weakest signal that can be observed and still provide a sufficient quality output.Sensitivity is determined by the sum of Thermal Noise ,Noise Figure and the Required prediction of SNR.It is normally a negative number(in dBm) and this means that a bigger number(more negative) equals a smaller signal.
The thermal noise is given by:
\begin{equation}
Noise_{dBm} = 10log(BW\cdot Te\cdot k\cdot 1000) + NF
\label{Noise1}
\end{equation}
where $BW$ is the bandwidth $Te$ is the thermal temperature and the $NF$ is the noise figure of the reviver.

Dynamic Range or else Signal to noise and Distortion Ratio(SINAD) is also very similar to the Signal to Noise Ratio(SNR). SINAD is a good way to describe the whole dynamic system of ADC because takes into account all the components that make noise and distortion,in other words takes into account the non-linearities. The difference between them can be shown in high frequencies because the SINAD gets affected by the distortions and degrades faster than the SNR that excludes the first 5 harmonics that are dominant.The clear difference can be shown from the two formulas:
\begin{equation}
\text{SINAD} = 20log\left(\frac{S}{N+D}\right)
\end{equation}

\begin{equation}
\text{SNR} = 20log\left(\frac{S}{N}\right)
\end{equation}
where S represents the signal power,N the Noise and D the Distortion.\citep{SINADandSNR}
\subsection{SNR margin estimation}

Because the noise might influence the deep fades of our signal, a minimum SNR margin needs to be estimated.
This gives us the SNR margin needed to distinguish a deep fade from the noise floor. % given a set confidence interval and margin.
%By doing this gives we will be able to accept the measurements that are above this margin and reject the ones that are affected by the noise.
The estimation assume the signal as a constant and the noise as a complex vector that changes. Therefore a Rician distribution can be used, because it consists of constant part and random part.
\begin{equation}
p = a^2 + 2\sigma^2
\end{equation}
\todo {change symbols}
Rician distribution fits in this situation because the K-factor that it depend upon is a ratio of power for the constant signal to the random noise, \citep{SpaceWirelessChan} meaning that the K-factor matches the SNR margin that we need to estimate.
\begin{equation}
K = \frac{a^2}{2\sigma^2}
\end{equation}
Given that we set our confidence interval of $\pm 1\%$dB around the value of our constant signal in the Rician cdf matched with the 90\% confidence level on the probability axis, we are able to estimate numerically the part of the K-factor that we are interested in.
\todo {Figure out how to do this in Matlab and make figures}

\subsection{How to measure dynamic range}

In a normal receiver the dynamic range is set by the sensitivity of the receiver to the Third order intercept point. Third order intercept points are caused by over driving the receiver with too much input and that causes distortion and signal saturation. The sensitivity is more dependent on the operating environment and the receivers noise figure. \citep{understandDynamic}


\begin{figure}[H]
\centering
\includegraphics[width=0.90\textwidth]{figures/Dynamic_range_calc.png}
\caption{Determining the Dynamic Range from the spurs and sensitivity line.(WORK IN PROGRESS!!)}
\label{Dynamic_range_calc}
\end{figure}
 
This means that a RF receiver is highly dependent on the mixer and amplifier with regards to dynamic range. A measurement system would take into account the factors listed in \autoref{basic_rev_struct} to increase the dynamic range. Going through the \autoref{fig:basic_receiver_structure} in order from left to right. The receivers \gls{IF} is the frequency that shifted to in order to process the signal easier.  This is done in the first stages of a receiver. This frequency is normally lower than the transmitted RF frequency, this especially helps the \gls{ADC} that uses a lower sampling rate. 
By setting the \gls{IF} filter to a very narrow bandwidth (narrowband) the noise floor goes down and increases the dynamic range. 

\section{Time to do a sweep}
The cost of using a narrowband is the measurement time, as the system would require a longer time for the sweep to cover a typical bandwidth. The time this would take is given by:
\todo{maybe write about averaging here and add it to the Time calculations}
\begin{equation}
T = \frac{1}{IF_{BW}} \cdot \frac{BW_{sweep}}{IF_{BW}}
\end{equation}
where $IF_{BW}$ is the intermediate frequency bandwidth and $BW_{sweep}$ is the total bandwidth you want to measure.


\subsection{Dynamic range in a VNA receiver}
\begin{figure}[H]
\centering
\includegraphics[width=0.90\textwidth]{figures/Block_VNA.png}
\caption{A Typical block diagram of a VNA receiver.}
\label{Block_VNA}
\end{figure}

For Network analysers the dynamic range is the maximum signal power the receiver can measure minus the noise floor of the receiver. To achieve a higher dynamic range of \gls{VNA} it must be  in tuned-receiver mode (Narrowband).
If you reduce the bandwidth then the overall noise floor will go down, so it logical that it would have higher dynamic range. \citep{AgilentNVA} \\
%%The setup of the \gls{VNA} measuring would have to take into account some factors to increase the dynamic range and still have the accuracy. Going through the \ref{Block_VNA} in order from left to right.
%%The \gls{IF} is a frequency that shifted to in order to process the signal easier. This is done in the first stages of a receiver. This frequency is normally lower than the transmitted RF frequency, this especially helps the \gls{ADC} that uses a lower sampling rate. 
%%By setting the \gls{IF} filter to a very narrow bandwidth (narrowband) the noise floor goes down and increases the dynamic range. The cost of using a narrowband is the measurement time, as the \gls{VNA} would need several sweeps to cover a typical bandwidth. \\

Dynamic range and accuracy are affected by the non-linearity in the receiver chain, the worst part are the mixers,\gls{ADC} and amplifiers since they introduce the most non-linearity. To measure the linearity of a receiver a power change measurements is preformed and compared to a reference level of power change that is accurate. This means that the linearity of a receiver as can be defined as:
\begin{equation}
Linearity = \frac{receiver \\\ measured \\\ power \\\ change}{reference \ power \ change}
\label{Linearity}
\end{equation}
 

Cross talk is the energy leakage between signal paths of the measuring system and it can be a problem in high-loss transmission measurements. This can be fixed by running an isolation calibration \citep{crosstalk}.It occurs below the noise floor so averaging and low \gls{IF} filter bandwidth must be used during calibration.
At low power levels <-70dBm the main non-linearity comes from the \gls{ADC}. Quantizing error occurs when converting from analog to digital signals. The \gls{ADC} used in \gls{VNA} are top of the line and can use a Gaussian noise ditcher to combat the non linear nature of a \gls{ADC}. 


In the digital signal processing of the \gls{VNA} averaging be applied to reduce the noise.Given the noise is uncorrelated, by averaging the measured(complex) data the noise component will approach zero.That means that our end signal in the output will be with less noise.Every time that our average is getting doubled, the signal to noise ratio is increased by 3dB. The problem is that by averaging the double of every data point the measurement will take twice as long.\citep{KeysightAVG}. The total noise floor is then given by:

\begin{equation}
Noisefloor_{dBm} = log_{2}(AVG_f)\cdot 3dB +10log(IF_{BW}\cdot T_{0}\cdot k\cdot 1000) + NF
\label{NFwithAVG}
\end{equation}
Where $IF_{BW}$ is  intermediate bandwidth $T_0$ is temperature of the system, $k$ is the Boltzmann's constant,$AVG$ is the averaging factor and $NF$ if the noise figure.
To maximise the effectiveness of a \gls{VNA} the reviver $IF_{BW}$ should be high as possible for the dynamic range needed. So to get accurate samples with the needed dynamic range in the least amount of time the $IF_{BW}$ and $AVG_f$ must be balanced to minimise time spent on one measurement.
Equipment drift is another source of error that can occur if we are operating in a place with different environmental factors for a long period of time.


%\section{Diversity}
%% (effects?)
%Diversity is used to combat fading in a wireless system. By using clever techniques you can effectively deliver several copies or replicas of a signal to the receiver. There is a lower chance that all of these copies of signals are going to have a deep fade at the same time \citep[p. 4-6]{diversityFuture}. The overall goal is to provide a gain in signal quality by having several signals that independently fade from each other without the cost of more power consumption, reduced bit rate and complexity or other resources. There are several ways to achieve diversity in a wireless system. \\
%Time diversity: By retransmitting the same information you get some diversity gain on the cost of decreased bit/rate. Usually a forward error correction code is added instead of just re transmitting the signals several times. \\
%Antenna diversity / Spatial diversity
%By having several antennas at both/or the receiver and transmitter a antenna diversity is achieved. With several antennas the signal can be combined together to process the signals into one. To get independently fading signals the signals need to be uncorrelated by separating the antennas least half a wavelength (micro diversity) \citep{diversityAntenna}. Antenna diversity comes at the cost of having to power more than one antenna.



