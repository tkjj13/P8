\chapter{Battery Lifetime of a NB-IoT Device} \label{ch:BatTest}
%Here should be an introduction of what we will test (the emulator and/or the protocol). 

The focus of this chapter is to provide an overview and an estimate of the power efficiency of the NB-IoT protocol. From \autoref{ch:NB-IoT} it is known that the desired performance of any IoT protocol is to achieve a battery life time of 10 years with a battery capacity of 5 Wh even in extreme situations. To do this the first step is to establish a model that considers the different aspects of the protocol and use of the devices.

\section{Battery Lifetime Estimation Model}
\label{sec:bat_model}

To model the battery lifetime of any cellular device can be done in a multitude of ways, depending on the cellular system as well as the complexity of the desired model. Here a very simple model is used to model a NB-IoT device. A similar attempt has been done in a collaboration between AAU, Kamstrup and Keysight \citep{Power_article}. The model will take offset in this work as it is simple and elegant, it should be noted that several factors is hidden in the model and influence of several parameters is not investigated. It is also seem to be assumed for the model that it does not experience interference in any way from other devices. The model will use this as a baseline due to its simplicity and potential. First is the general description of the battery lifetime \citep{Power_article}:

\begin{equation}
L(T_i) = \frac{C_{bat}\cdot SF_{bat}}{8760 \left(P_m(T_i) + P_{device}\right)}
\end{equation}
\begin{where}
\va{$L(T_i)$}{is the expected lifetime of the battery}{y}
\va{$T_i$}{is the transmission time interval}{h}
\va{$C_{bat}$}{is the capacity of the battery}{Wh}
\va{$SF_{bat}$}{is the safety factor of the battery}{1}
\va{8760}{is the number of ours in a year}{$\frac{h}{y}$}
\va{$P_m(T_i)$}{is the power consumption of the modem}{W}
\va{$P_{device}$}{is the power consumption of the IoT device}{W}
\end{where}

This equation lays the foundation of the battery lifetime model, here the power consumption has been split between the functionality of the device and the NB-IoT modem itself. The factors explained further in the following sections.

\subsection{Modem Power Consumption}

To define the power consumption of the modem several different approaches can be used. It is important to note that just by looking at a single instance of powering on transmitting and going back to idle or off puts the device through several different phases for which a multitude of parameters is influential. To keep the model simple it is assumed that each transmission goes through three phases and that the device is idle for the rest of the duration. The phases are connecting to the cell, transmitting the data and releasing the cell again. It is thereby assumed that all data will be mobile originated and not mobile terminated. This means that the modem power consumption can be modelled as:

\begin{equation}
P_m(t_i) = \frac{E_{conn} + E_{transmit} + E_{disconn} + E_{idle}}{T_i}
\end{equation}
\begin{where}
\va{$E_{conn}$}{is the energy used to connect to the network}{J}
\va{$E_{transmit}$}{is the energy used during transmission}{J}
%\va{$t_{tx}$}{is the time it takes to transmit}{s}
\va{$E_{disconn}$}{is the energy used to disconnect from the network}{J}
\va{$E_{idle}$}{is the energy used during the idle period}{J}
%\va{$t_{conn}$}{is the time it takes to connect to the network}{s}
%\va{$t_{disconn}$}{is the time it takes to disconnect from the network}{s}
\end{where}


\textbf{Energy used to Connect to the Network}\\
The first term is the energy used to connect to the network, this covers the energy it takes to boot up the modem find and synchronize to a cell as well as perform an attach procedure. 

\begin{equation}
E_{conn} = E_{modem,on} + E_{sync} + E_{attach}
\end{equation}
\begin{where}
\va{$E_{modem,on}$}{is the energy needed to turn the modem on}{J}
\va{$E_{sync}$}{is the energy used to synchronize the device to the network}{J}
\va{$E_{attach}$}{is the energy to attach the device to the network}{J}
\end{where}

Each of these phase's energy consumptions is dependent on a set of parameters. An overview of these parameters is found in \autoref{tab:Econn_parameter_overview}.

\begin{table}[H]
\centering
\begin{tabular}{|m{3cm}|m{6cm}|} \hline
\textbf{Term} & \textbf{Parameters} \\ \hline
$E_{modem,on}$ & \begin{itemize} 
\item modem
\end{itemize} \\ \hline
$E_{sync}$ & \begin{itemize}
\item frequency
\item modem
\item SIB repetition
\end{itemize} \\ \hline
$E_{attach}$ & \begin{itemize}
\item bandwidth
\item \gls{CP}-format
\item frequency
\item modem 
\item \gls{MCS}
\item NPRACH interval
\item NPRACH power level
\item number of antenna ports
\item operation mode
\item repetition
\item sub-carrier spacing
\item \gls{TBS}
\item transmission gap size
\item transmit power
\end{itemize} \\ \hline
\end{tabular}
\caption{Paremeter overview for each term in the connection energy calculation.}
\label{tab:Econn_parameter_overview}
\end{table}



\textbf{Transmission Power}\\
To calculate the energy used for a transmission it is split up in to the average power consumption and the time used to transmit the data. 
\begin{equation}
E_{transmit} = P_{transmit}\cdot T_{transmit}
\end{equation}
\begin{where}
\va{$P_{transmit}$}{is the average power consumption during a transmission period}{W}
\va{$T_{transmit}$}{is the time it takes to transmit the data}{s}
\end{where}

Both of these factor's energy consumptions is dependent on other parameters. An overview of these parameters is found in \autoref{tab:Etransmit_parameter_overview}.

\begin{table}[H]
\centering
\begin{tabular}{|m{3cm}|m{6cm}|} \hline
\textbf{Term} & \textbf{Parameters} \\ \hline
$P_{transmit}$ & \begin{itemize}
\item frequency
\item modem
\item transmit power 
\end{itemize} \\ \hline
$T_{transmit}$ & \begin{itemize}
\item amount of data
\item bandwidth
\item \gls{MCS}
\item NPRACH interval
\item operation mode
\item repetition
\item sub-carrier spacing
\item \gls{TBS}
\item transmission gap size
\end{itemize} \\ \hline
\end{tabular}
\caption{Paremeter overview for each term in the transmit energy calculation.}
\label{tab:Etransmit_parameter_overview}
\end{table}


\textbf{Disconnection Energy}\\
The disconnection energy covers the energy it takes to detach the device from the network and go into idle mode. The disconnection energy is dependent on several parameters as seen in \autoref{tab:Erelease_parameter_overview}.

\begin{table}[H]
\centering
\begin{tabular}{|m{3cm}|m{6cm}|} \hline
\textbf{Term} & \textbf{Parameters} \\ \hline
$E_{diconn}$ & \begin{itemize}
\item bandwidth
\item \gls{CP}-format
\item frequency
\item \gls{MCS}
\item modem 
\item NPRACH interval
\item NPRACH power level
\item number of antenna ports
\item operation mode
\item repetition
\item sub-carrier spacing
\item \gls{TBS}
\item transmission gap size
\item transmit power
\end{itemize} \\ \hline
\end{tabular}
\caption{Paremeter overview for disconnection energy.}
\label{tab:Erelease_parameter_overview}
\end{table}

\textbf{Idle Mode Power}\\
Idle mode power consumption covers several things, as the device has a few options when going unto idle mode. Four types of idle mode is defined in \gls{NB-IoT} namely: \gls{cDRX}, \gls{DRX}, \gls{eDRX} and \gls{PSM}. The case of cDRX will not be considered as this means the device would actually stay connected to the network after it is done transmitting. The case of DRX is not really considered either as it can be covered by the PSM case. 
  
\begin{equation}
E_{idle} = \begin{cases} P_{DRX}\cdot T_{PTW}+P_{PSM}\cdot T_{PSM} \qquad \text{for eDRX}\\
			 P_{DRX}\cdot T_{DRX} + P_{PSM}\cdot (T_i-T_{DRX}-T_{attach}-T_{transmit}) \qquad \text{for PSM}
		   \end{cases}
\end{equation}
\begin{where}
\va{$P_{DRX}$}{is the average power consumption during DRX}{W}
\va{$T_{PTW}$}{is the length of the \gls{PTW}}{s}
\va{$P_{PSM}$}{is the average power consumption of the device in PSM}{W}
\va{$T_{DRX}$}{is the time spent in DRX mode before going into PSM mode}{s}
\va{$T_{attach}$}{is the time it takes to attach the device to the network}{s}
\end{where}

The dependency for these factors are explained in \autoref{sec:Network_access}.



\subsection{Other Parameters}
The other parameters include device power, battery capacity and the safety factor of the battery.

\textbf{Device Power Consumption}\\
Because the functionality of the device vary depending on the use case is it very hard to put up a model for it. As all relevant use cases here is assumed low energy it can be assumed that the factor have little influence on the overall battery lifetime, however a measurement or a more specific model is needed to give an accurate estimate of the battery lifetime.

\textbf{Battery Capacity}\\
A performance objective for IoT protocols is to achieve a battery lifetime of 10 years on a 5 Wh battery. 

\textbf{Safety Factor}\\
The safety factor is depending on which battery is used. In the article which also put up a battery lifetime model they used 0.5 \citep{Power_article}, however from the standards specify a safety factor of 1 for the performance objective which will be used here \citep[Sec. 5.4]{safty_factor_standard}.


\section{Test Setup}
To use the model effectively several elements needs to be measured on an actual device, these are:

\begin{tabular}{ll}
$E_{sync}$ & the energy used for the modem to boot and synchronise to a cell. \\
$E_{attach}$ & the energy needed to attach the device to the cell. \\
$P_{transmit}$ & the power consumption during the data transmission. \\
$E_{release}$ & the energy spent when disconnecting from the cell. \\
$P_{eDRX}$ & the power consumption during \gls{eDRX} idle mode. \\
$P_{PSM}$ & the power consumption during \gls{PSM} idle mode. \\
\end{tabular}

Multiple devices would of cause increase the accuracy of the model, but here only evaluation board for the Quectel BC95 modem is tested \citep{BC95}. Even with that a \gls{NB-IoT} system has a multitude of parameters which can influence the throughput and energy consumption. To account for all of this is to huge a task for this project, therefore a couple of parameters are chosen to simplify this task. The downside of this is the reliability of the results as these can only be assume valid in cases where the other parameters are chosen to the same values as used in this project. The values chosen are CP format, operation mode, frequency and $P_{TX}$. The CP format and operation mode is chosen as these are some often mentioned parameters which also only has a few values, repetition could also be considered here however as four different channels can be repeated with each having its own specifying parameter it is chosen to set all repetition to 1 and leave this parameter up to future analysis. The frequency typically has a high influence on the hardware used it is therefore considered as well as the transmit power, $P_{TX}$, which also will have a significant influence on the power consumption when the device is active. For the four parameters the values chosen can be seen in \autoref{tab:par_val}, note that these ranges are only valid for the measurements containing to the specific parameter, in all other cases a fixed value is chosen instead.

\begin{table}[H]
\centering
\begin{tabular}{|c|p{8cm}|} \hline
\textbf{Parameter} & \textbf{Values} \\ \hline
CP-format & Extended and normal\\ \hline
Frequency & From 791 MHz to 820.8 MHz with 0.2 MHz interval corresponding to EARFCN 6150 to 6448 with steps of 2 \\ \hline
Operation mode & Guard-band, in-band and standalone \\ \hline
$P_{TX}$ & From -30 dBm to 23 dBm with 1 dB interval \\ \hline
\end{tabular}
\caption{Parameters and the corresponding values}
\label{tab:par_val}
\end{table}

Some of the main parameters that are not tested besides repetition is \gls{MCS}, \gls{TBS}, NPRACH start power, NPRACH step size, number of tones, sub-carrier spacing, number of antenna ports and LTE parameters in inband deployment. The influence of some of these parameters is tested by a NDS group at Aalborg University \citep{NDS_report}. However it will not be further considered here.

In each of the following graphs that depicts the measured data points, the order of the parameter is the same as in \autoref{tab:par_val}. From a measurement perspective some of the elements can and should be measured together, these are $E_{sync}$ and $E_{attach}$. This is because these steps are depending on each other and can only be separated during the  post processing. Likewise the $E_{release}$ could be tested simultaneously as it requires the DUT to be connected and depends on most of the same parameters.  




%Here should be a description of the general setup (including figure) used in all test and a list of baseline values for all parameters. Including physical setup, BSE, UEE.
All the parameters can be tested with the same setup which can be seen in \autoref{fig:IPE_test_setup}.

\begin{figure}[H]
\centering
%\includegraphics[width=0.5\textwidth]{figures/IPE_test_setup.pdf}
\input{figures/Test_Setup_Bat.tex}
\caption{Setup used to test for the power efficiency of the \gls{DUT}'s}
\label{fig:IPE_test_setup}
\end{figure}


As seen in \autoref{fig:IPE_test_setup}, an orchestrator, in this case \gls{TAP}, maintains the system. The orchestrator has a \gls{LAN} connection with the \gls{PSU} and the UXM and in this case a serial connection with the DUT. The \gls{PSU}s connection with the DUT is wires used to power on and analyse the power consumption of the device. It should be noted that the \gls{DUT} in question have two power inputs, one for the device power and one for the RF modem power, here only the modem is connected to the power analyser. The DUT is connected to the UXM using RF SMA cables.

\gls{TAP} is a software developed by Keysight Technologies which enables quick and easy access to the computers external connection. It also allows for C\# features to be used in the test design, meaning test steps can and has been designed to enable functionalities of the instruments. This includes for instance cell activation of the UXM and data collection from the PSU among other key functionalities, this couple with the ability to use loops, parallel test steps, serial com ports and batch scripts make this a very strong tool in designing, controlling and performing measurements. \citep{TAP} 

The \gls{PSU} is a N6705C DC Power Analyzer with the internal module 2Q SMU-BDA it has a range of 20 V and 3 A with a max output of 20 W. When getting data from the PSU it can be done in a couple different ways, but here it is stored in the internal RAM of the PSU before download. This though has a limitation of 512.000 data points per capture. \citep{PSU}

The base station is a E7515A UXM Wireless Test Set from Keysight Technologies which is able to emulate, both LTE and NB-IoT conditions. It features most of the functionalities in the NB-IoT protocol until release 13. It has a multitude of changeable parameters with easy access through a SCPI interface. \citep{UXM}

The initial settings of each component in the system can be seen in \autoref{tab:setup_parameters}.

\begin{table}[H]
\captionsetup{belowskip=0em}
\noindent
\centering
%\resizebox{!}{0.5\textheight}{
\begin{minipage}[t]{0.48\textwidth}
\begin{tabular}{|p{4cm}|p{2cm}|} \hline
\multicolumn{2}{|c|}{\textbf{Ekstern IoT device}}   \\ \hline
DL\_EARFCN         & 6240           \\ \hline
Enable             & Off            \\ \hline
\multicolumn{2}{c}{}  \\ 
\multicolumn{2}{c}{}  \\ 
\end{tabular}
%\caption{Initial values of the parameters in the emulator.}
\end{minipage}% 
\hfill
\begin{minipage}[t]{0.48\textwidth}
\raggedleft
\begin{tabular}{|p{4cm}|p{2cm}|} \hline
\multicolumn{2}{|c|}{\textbf{Power Supply/Analyser}} \\ \hline
Ampere             & 2.5 A          \\ \hline
Enable             & Off            \\ \hline
Sample interval	   & 100 $\mu$s		\\ \hline
Volt               & 3.6 V          \\ \hline
\end{tabular}
%\caption{Initial values of the parameters in the emulator.}
%\label{tab:setup_parameters}
\vspace{1em}
\end{minipage}
\resizebox{\textwidth}{!}{
\begin{tabular}{|p{5cm}|p{3cm}|p{4cm}|p{3cm}|} \hline
\multicolumn{4}{|c|}{\textbf{UXM \gls{BSE}}} \\ \hline
Cell ID                   & 0        & Cell type              	& NB-IoT         \\ \hline
CP format                 & Normal   & DRX Start Offset       	& 0              \\ \hline
drx-ULRetransmissionTimer & 0        & Host cell DL\_EARFCN 	& 6240           \\ \hline
Idle eDRX Cycle     & 20480 subframes& Idle eDRX State        	& Off            \\ \hline
Inactivity Timer        & 8 NPDCCH subframes & Long DRX cycle   & 1024 subframes \\ \hline
MAC padding DL           & off       & Max Repetition NPDCCH 	& 4              \\ \hline
Number of cells          & 1         & onDuration Timer         & 4 NPDCCH subframes \\ \hline
Operation mode           & Standalone& Power Saving Mode		& Off            \\ \hline
PRB offset               & 0         &$P_{TX}$                  & 23 dBm         \\ \hline
\gls{PTW}                & 5120 subframes & Repetition NPDSCH   & 1              \\ \hline
Repetition NPRACH        & 1         & Repetition NPUSCH        & 1              \\ \hline
Retransmission Timer & 2 NPDCCH subframes & T3324 (DRX period)  & 10 s           \\ \hline
T3412 (PSM period)      & 10 s       & Tx power                 & -80 dB/per 15 kHz \\ \hline
\end{tabular}}
\caption{Initial values of the parameters in the emulator.}
\label{tab:setup_parameters}
\end{table}

The procedures to measure the different elements can be in \appref{app:test_procedures}. When the data is procured the energy, power and time is needed for different parts of the measurement and is calculated respectively as:

\begin{align}
E &= \int_{A_{start}}^{A_{end}} f(x) dx \label{eq:energy}\\
P &= \mathbf{E}(f(x)) \quad for \, A_{start} \leq x \leq A_{end} \label{eq:power} \\
T &=  A_{end} - A_{start} \label{eq:time}\\
\end{align}
\begin{where}
\va{$E$}{is the energy of area A}{J}
\va{$P$}{is the average power consumption of area A}{W} 
\va{$T$}{is the duration of area A}{s}
\va{$\mathbf{E}$(•)}{is the mean function}{1}
\va{f(x)}{is the data point at time x}{W}
\va{$A_{start}$}{is the start time of area A}{s}
\va{$A_{end}$}{is the end time of area A}{s}
\end{where}

%Four different kinds of idle mode exist for a NB-IoT device: \gls{cDRX}, \gls{DRX}, \gls{eDRX} and \gls{PSM}. It is chosen not to look into \gls{cDRX} due to an assumption of the device transmitting its data quickly and then going into deep sleep. 

%When the device is in idle mode most parameters lose their influence entirely. Because of this a whole new set of parameters should be considered. For the \gls{DRX} case the cycle period is important, while for \gls{eDRX} however a few parameter more should be considered such as the repetition of the DRX cycle and the eDRX cycle period. For \gls{PSM} its is also the DRX cycle period as well as the repetition of the DRX cycle as well as the PSM cycle time. This can be summed up to two different types of parameters: period lengths and repetition numbers. It is assumed that both of these parameters have a proportional relation to the energy consumption of the idle modes, this means that only a single instance of the power consumption is needed for these different idle modes to extrapolate from.






%\subsubsection{Device Power Consumption}
%
%To measure the device power, the power input to the device is used in the setup. The test is performed using the following procedure:
%
%\textbf{Test Procedure}
%\vspace{-1.5em}
%\begin{enumerate}
%\item Setup the \gls{DUT} as shown on \autoref{fig:IPE_test_setup}
%\item Put in settings as described in \autoref{tab:setup_parameters} and \autoref{tab:UXM_initial_values} 
%\item Turn on power supply 
%\item Measure power output over 2 min
%\item Save measurements as "<device>\_Power\_consumption"
%\item Turn off power supply
%\item Change to next \gls{DUT}
%\item Repeat step 1-7 for all \gls{DUT}s.
%\end{enumerate}
%
%\textbf{Results}\\
%\begin{table}[H]
%\centering
%\begin{tabular}{|c|c|c|c|}\hline
%\textbf{Device}	& Quectel	& Telit & Ublox \\ \hline
%$\mathbf{P_{device}}$	& & & \\ \hline
%\end{tabular}
%\caption{Average power consumption of the \gls{DUT}s}
%\label{tab:device_power_results}
%\end{table}

\section{Energy to Connect and Disconnect the DUT to the Cell} \label{sec:performance_attach}

The energy to connect and disconnect the DUT to the cell involves the elements $E_{sync}$, $E_{attach}$ and $E_{release}$. The procedure to measure these can be found in \appref{app:test_procedures}. The first step is to get an overview of the measurements, to do this an example of the raw data from a measurement is presented in \autoref{fig:Attach_raw}. The areas are related to the elements in order, area D is when the device has been release and is therefore not used.

\tikzsetnextfilename{Attach_raw}
\begin{figure}[H]
\centering
\begin{minipage}[tbp]{0.58\textwidth}
\resizebox{\textwidth}{!}{
\input{figures/QuectelMeas/Attach_raw.tex}}
\end{minipage}%
\begin{minipage}[tbp]{0.39\textwidth}
\resizebox{\textwidth}{!}{
\begin{tabular}{|c|p{6.5cm}|} \hline
\multicolumn{2}{|c|}{\textbf{Log messages}} \\ \hline
\textbf{Line number} & \textbf{Message} \\ \hline
1 & Security Protected NAS Message (Attach Request) \\ \hline
2 & Security Protected NAS Message (Authentication Response) \\ \hline
3 & Security Protected NAS Message (Security Mode Command) \\ \hline
4 & Security Protected NAS Message (Security Mode Complete) \\ \hline
5 & Security Protected NAS Message (Attach Accept) \\ \hline
6 & Security Protected NAS Message (Attach Complete) \\ \hline
\end{tabular}}
\end{minipage}
\caption{Example of raw data from measurement. Area A is boot up and cell synchronization, area B is attach procedure, area C is Cell release and area D is off period. Dashed line indicates log messages.}
\label{fig:Attach_raw}
\end{figure}

In \autoref{sec:bat_model} it was found that three elements is needed from this measurement. First the energy used in the synchronization phase is found based on \autoref{eq:energy}. This is done for area A which is defined as the start of the measurement to the start of the NPRACH. The start of the NPRACH is located based on the associated log. A small amount of idle time is included in this area but it is assessed that it is negligible. The result of this is presented in \autoref{fig:Sync_Points}. 



\begin{figure}[H]
\centering
\begin{minipage}{0.48\textwidth}
\tikzsetnextfilename{Sync_Points}
\resizebox{\textwidth}{!}{
\input{figures/QuectelMeas/Sync_Points.tex}}
\end{minipage}
\hfill
\begin{minipage}{0.48\textwidth}
\tikzsetnextfilename{Sync_Stat}
\resizebox{\textwidth}{!}{
\input{figures/QuectelMeas/Sync_Stat.tex}}
\end{minipage}
\caption{Energy consumed during boot up and cell synchronization.}
\label{fig:Sync_Points}
\end{figure}

As it can be seen in \autoref{fig:Sync_Points} all of the considered parameters is without characteristic influence. It can be seen though that a few points is a little higher than the rest, but looking at it statistically they can be neglected, this is also expected as seen in \autoref{sec:bat_model}. A single point is therefore chosen as it is assumed the small discrepancies around it is due to the small difference in synchronization time, that might arise depending on where in the \gls{SIB} messages the device gets active. 

The next element to look at is the energy used to attach to the network. This is found based on the log where a messages is telling where the NPRACH starts and where the attach is complete. This can be seen as area B in \autoref{fig:Attach_raw}. It is determined to split the energy into the average power and the time it takes based on the measurements. First the power is found based on \autoref{eq:power} for area B. 
This is done for all measurements and the results are presented in \autoref{fig:Attach_Power_Points}.

\begin{figure}[H]
\centering
\begin{minipage}{0.48\textwidth}
\tikzsetnextfilename{Attach_Power_Points}
\resizebox{\textwidth}{!}{
\input{figures/QuectelMeas/Attach_Power_Points.tex}}
\end{minipage}
\hfill
\begin{minipage}{0.48\textwidth}
\tikzsetnextfilename{Attach_Power_Stat}
\resizebox{\textwidth}{!}{
\input{figures/QuectelMeas/Attach_Power_Stat.tex}}
\end{minipage}
\caption{Average power consumption during attach procedure.}
\label{fig:Attach_Power_Points}
\end{figure}

As seen from \autoref{fig:Attach_Power_Points} the $P_{TX}$ has a significant effect on the average power consumption and is will therefore be investigated separately. It looks like almost all frequency measurements is a layer above the others, this is unexpected as a common point shared across all four parameters, which should therefore have used the same average power. It might also look like CP-format and operation mode has an influence on the average power consumption, but comparing to the spread of the frequency it is neglectable. The variance is investigated statistically, a lognormal distribution is chosen to approximate the power consumption as it is assumed, that the fluctuation of the current should be normal distributed and since the power is the current squared and therefore always positive it would should have a lognormal behaviour.  

As mentioned the parameter $P_{TX}$ influences the mean value of the power consumption during the attach procedure, this can be seen in \autoref{fig:Attach_Pmax}. 

\begin{figure}[H]
\centering
\tikzsetnextfilename{Attach_Pmax}
\resizebox{0.7\textwidth}{!}{
\input{figures/QuectelMeas/Attach_Pmax.tex}}
\caption{Average power consumption as a function of $P_{TX}$ during the attach procedure.}
\label{fig:Attach_Pmax}
\end{figure}

From \autoref{fig:Attach_Pmax} it can be seen that the power consumption can be approximated using two functions based on the value of $P_{TX}$. The need for two function to approximate the characteristic can be contributed to the usage of a power amplifier. This parameter determines the mean value of the average power consumption. 

Now the time to attach is investigated the time is found based on \autoref{eq:time} and the results can be seen in \autoref{fig:Attach_Time_Points}.


\begin{figure}[H]
\centering
\begin{minipage}{0.48\textwidth}
\tikzsetnextfilename{Attach_Time_Points}
\resizebox{\textwidth}{!}{
\input{figures/QuectelMeas/Attach_Time_Points.tex}}
\end{minipage}
\hfill
\begin{minipage}{0.48\textwidth}
\tikzsetnextfilename{Attach_Time_Stat}
\resizebox{\textwidth}{!}{
\input{figures/QuectelMeas/Attach_Time_Stat.tex}}
\end{minipage}
\caption{Time spent during attach procedure.}
\label{fig:Attach_Time_Points}
\end{figure}

As can be seen in \autoref{fig:Attach_Time_Points} the time to attach seems to centered around certain values. This could very potentially be based on the occurrences of NPRACH occasions. Beside this none of the parameters seems to influence the time it takes. Because of this a point distribution is applied as it fits this scenario. 

The final element is the energy needed to release the the device. This is found based on area C which is the time after the attach is completed and until the power drops to just around zero. It is investigated like the attach element by splitting it up into power and time. The average power consumption is found based on \autoref{eq:power}. The result of which can be seen in \autoref{fig:Release_Power_Points}.

\begin{figure}[H]
\centering
\begin{minipage}{0.48\textwidth}
\tikzsetnextfilename{Release_Power_Points}
\resizebox{\textwidth}{!}{
\input{figures/QuectelMeas/Release_Power_Points.tex}}
\end{minipage}
\hfill
\begin{minipage}{0.48\textwidth}
\tikzsetnextfilename{Release_Stat}
\resizebox{\textwidth}{!}{
\input{figures/QuectelMeas/Release_Power_Stat.tex}}
\end{minipage}
\caption{Average power consumption during release sequence.}
\label{fig:Release_Power_Points}
\end{figure}

%In the same sense as with the power two peaks can be seen here, but again a unimodal distribution is used as no explanation is known to do otherwise. A little surprisingly it does not seem that the $P_{TX}$ has any significant influence on the energy consumption. It is chosen to use a lognormal distribution for the same reasoning as with the average power consumption for the attach procedure.   
It is seen from \autoref{fig:Release_Power_Points}, that the $P_{TX}$ has an influence, however compared to the influence on the attach procedure the impact is not nearly as defined. It is believe to be because to the energy is mainly spent on RX instead of TX. Likewise the other parameters their own mean value which should not be the case since they share points across the measurements. What can be taken from this is the model does not really support a complicated scenario like a release procedure. Because of this a statistical analysis of the distribution does not make much sense, however instead the value for which 95\% of the measurements is contained is found based on a CDF of the data. 

The time to do the release sequence is found based on \autoref{eq:time} for area C. This is done for all the measurements and the result can be seen in \autoref{fig:Release_Time_Points}. 

\begin{figure}[H]
\centering
\begin{minipage}{0.48\textwidth}
\tikzsetnextfilename{Release_Time_Points}
\resizebox{\textwidth}{!}{
\input{figures/QuectelMeas/Release_Time_Points.tex}}
\end{minipage}
\hfill
\begin{minipage}{0.48\textwidth}
\tikzsetnextfilename{Release_Time_Stat1}
\resizebox{\textwidth}{!}{
\input{figures/QuectelMeas/Release_Time_Stat1.tex}}
\end{minipage}
\caption{Time spent during release sequence.}
\label{fig:Release_Time_Points}
\end{figure}

It can be seen that the time it takes to release the device from the network varies a lot. Based on the networks structure, restrictions are made about how long time it can take, but to account for all the values with e.g. a point distribution is not really feasible. Because of this the same trick is applied as with the average power consumption and the 95\% point is found based on the CDF of the data, which can be seen in \autoref{fig:Release_Time_Stat2}.

\begin{figure}[H]
\centering
\begin{minipage}{0.48\textwidth}
\tikzsetnextfilename{Release_Time_Stat2}
\resizebox{\textwidth}{!}{
\input{figures/QuectelMeas/Release_Time_Stat2.tex}}
\end{minipage}
\caption{Time spent during release sequence.}
\label{fig:Release_Time_Stat2}
\end{figure}

From this it can concluded that the elements are uninfluenced by CP format, frequency, operation mode and $P_{TX}$ except in the case of $P_{attach}$ where $P_{TX}$ influences the mean value, but also that the model might be a bit too simplified. Based on the measurement the elements can be described as follows:

\begin{align}
E_{sync} &= 0.223 [J] \\
P_{attach} &\sim\text{Lognormal}(\mu_{attach},4.4274\cdot 10^{-4}) [W] \\
\mu_{attach} &= \begin{cases} \log\left(0.1328\cdot\exp(1.4\cdot 10^{-3}\cdot x) + 1.51\cdot 10^{-3}\exp(0.229\cdot x)\right) \quad for x \leq 8 dBm \\
\log\left(0.1225\cdot\exp(21.0\cdot 10^{-3}\cdot x) + 11.7\cdot 10^{-12}\cdot \exp(0.981\cdot x)\right) \quad for x > 8 dBm \end{cases} \\
T_{attach} &\sim\begin{cases} 2.215 [s] \quad p = 0.2584\\
2.345 [s] \quad p = 0.4382\\
2.470 [s] \quad p = 0.1124\\
2.615 [s] \quad p = 0.1573\\
2.725 [s] \quad p = 0.0337
\end{cases}\\
E_{release} &=0.1799 [W] \cdot 2.938 [s] 
\end{align}




\section{Transmit Power Consumption}

The transmit power consumption involves the elment $P_{transmit}$, to measure this the UXM needs to enable the MAC padding this is done in both UL and DL to ensure the maximum utilization of the device. The full procedure can be found in \appref{app:test_procedures}. An example of the raw data can be seen in \autoref{fig:Transmit_raw}.

\begin{figure}[H]
\centering
\tikzsetnextfilename{Transmit_raw}
\resizebox{0.6\textwidth}{!}{
\input{figures/QuectelMeas/Transmit_raw.tex}}
\caption{Example of raw measurements of the transmit case.}
\label{fig:Transmit_raw}
\end{figure}

As seen in \autoref{fig:Transmit_raw} the device is in a transmit state for the entirety of the measurement. The average power consumption is therefore calculated based on \autoref{eq:power} with the whole measurement being the area of interest. This is done for all parameters and the result can be seen in \autoref{fig:Transmit_Points}.

\begin{figure}[H]
\centering
\begin{minipage}{0.48\textwidth}
\tikzsetnextfilename{Transmit_Points}
\resizebox{\textwidth}{!}{
\input{figures/QuectelMeas/Transmit_Points.tex}}
\end{minipage}
\hfill
\begin{minipage}{0.48\textwidth}
\tikzsetnextfilename{Transmit_Stat}
\resizebox{\textwidth}{!}{
\input{figures/QuectelMeas/Transmit_Stat.tex}}
\end{minipage}
\caption{Average power consumption when in transmit state.}
\label{fig:Transmit_Points}
\end{figure}

As $P_{transmit}$ shares several traits with $P_{attach}$ it can also be modelled using a lognormal distribution with $P_{TX}$ setting the mean value. An issue arises however because as seen the mesurement of CP-format with a value of normal is placed significantly lower than the rest. When calculating the mean and variance of the lognormal distribution this point is omitted since all the other points has this as a standard value. The reason this point is so low is unknown. The influence of $P_{TX}$ can be seen in \autoref{fig:Transmit_Pmax}. 

\begin{figure}[H]
\centering
\tikzsetnextfilename{Transmit_Pmax}
\resizebox{0.7\textwidth}{!}{
\input{figures/QuectelMeas/Transmit_Pmax.tex}}
\caption{Average power consumption as a function of $P_{TX}$ during a transmit phase.}
\label{fig:Transmit_Pmax}
\end{figure}

The influence on the average power consumption can be modelled using two function which again can be contributed to the use of a power amplifier. This means that $P_{transmit}$ can be modelled as:

\begin{align}
&P_{transmit} \sim \text{Lognormal}(\mu_{Pmax},6.0040\cdot 10^{-6}) [W]\\ \nonumber
&\mu_{Pmax} = \begin{cases} 0.0433\cdot\exp{(0.0002\cdot x)} + 4.13\cdot10^{-3}\cdot\exp{(0.116\cdot x)} \quad for x \leq 8 dBm \\
0.0399\cdot\exp{(0.0442\cdot x)} + 22.3\cdot10^{-6}\cdot\exp{(0.545\cdot x)} \quad for x > 8 dBm \end{cases}
\end{align}


\section{Idle Mode Power Consumption}
The idle mode power consumption involves the elements $P_{eDRX}$ and $P_{PSM}$, to measure those the device is release from the cell after the desired idle mode is enabled. The procedure used to measure the idle modes can be found in \appref{app:test_procedures}. The raw data from each of the idle mode measurements can be seen in the following figures.

\begin{minipage}{0.48\textwidth}
\begin{figure}[H]
\tikzsetnextfilename{DRX1}
\centering
\resizebox{\textwidth}{!}{
\input{figures/QuectelMeas/DRX1.tex}}
\caption{Raw measurement of \gls{DRX}. Area A is connection phase and area B is DRX phase.}
\label{fig:DRX}
\end{figure}
\vspace{0.8em}
\end{minipage}%
\hfill
\begin{minipage}{0.48\textwidth}
\begin{figure}[H]
\tikzsetnextfilename{PSM1}
\centering
\resizebox{\textwidth}{!}{
\input{figures/QuectelMeas/PSM1.tex}}
\caption{Raw measurement of \gls{PSM}. Area A is connection phase, area B is DRX phase, area C is the PSM phase and area D is the tracking area update phase.}
\label{fig:PSM}
\end{figure}
\end{minipage}
\vspace{1em}
\begin{figure}[H]
\tikzsetnextfilename{eDRX1}
\centering
\begin{minipage}{0.48\textwidth}
\resizebox{\textwidth}{!}{
\input{figures/QuectelMeas/eDRX1.tex}}
\caption{Raw measurement of \gls{eDRX}. Area A is connection phase, area B is the sleep phase of the first eDRX cycle, area C is the \gls{PTW} of the first eDRX cycle, area D is the sleep phase of the second eDRX cycle and area E is the \gls{PTW} of the second eDRX cycle.}
\label{fig:eDRX1}
\end{minipage}
\end{figure}

As can be seen in the raw measurements each mode has several phases. Phase A of each measurement can be omitted from the analysis since this is the attach phase, which has already been covered in \autoref{sec:performance_attach}. The average power consumption is found for each of the other areas following \autoref{eq:power}, for each area. The results can be seen in \autoref{tab:idle_results}.

\begin{table}[H]
\centering
\begin{tabular}{|c|c|c|c|c|} 
\multicolumn{1}{c}{ }	& \multicolumn{4}{c}{Area} \\ \hline
\textbf{Mode}	& \textbf{B}	& \textbf{C} 	& \textbf{D} 	& \textbf{E} \\ \hline
DRX				& 1.898 mW		& - 			& - 			& - \\ \hline
eDRX			& 3.653 $\mu$W	& 1.901 mW		& 5.738 $\mu$W	& 1.903 mW \\ \hline
PSM 			& 1.520 mW		& 3.919 $\mu$W	& 31.62 mW		& - \\ \hline 
\end{tabular}
\caption{Average power consumption of the individual areas for the the three idle measurements.}
\label{tab:idle_results}
\end{table}

It can be seen that the average power consumption of the DRX period is almost equal to the average power consumption of the PTW of the eDRX cycle, this is also expected. It can further be seen that the in the off periods of the eDRX cycle the Quectel device shuts down to the same state as in PSM mode. This could  mean one of two things, either the device has very bad hardware meaning the PSM power consumption is very high, or as in this case the hardware is very good and it can keep the timing sufficiently with only the timer needed to run PSM mode. This means that the power consumption during the eDRX idle periods can be counted as PSM period. This means that only two values is needed to describe the power consumption during the idle phase $P_{DRX}$ and $P_{PSM}$. The average of DRX periods is found from area B, C, E and B of the DRX, eDRX, eDRX and PSM measurements respectively. The average of the PSM periods is found from area B, D and C of the eDRX, eDRX and PSM measurements respectively.

\begin{align}
P_{DRX} &= 1.806 [mW] \\
P_{PSM} &= 4.437 [\mu W]
\end{align}


\section{Battery Lifetime Estimations}

Now that all the power values are known the battery lifetime can be estimated. To do this however the influence of some cell specific parameters as well as some assumptions of the transmit time is needed. As stated in \autoref{sec:bat_model} the model used to estimated the battery life time is:

\begin{equation}
L(T_i) = \frac{C_{bat}\cdot SF_{bat}}{8760\cdot (P_m(T_i) + P_{device})}
\end{equation}


This equation is used under the assumption that $P_{device}$ is negligible, that there is no mobile terminated data occurring and as the standards specify, that $SF_{bat}$ is 1 and $C_{bat}$ is 5 Wh \citep[sec. 5.4]{safty_factor_standard}. This reduces the equation to:
\begin{equation}\label{eq:bat_est}
\begin{gathered}
	L(t_i) = \frac{2.0548}{P_m(T_i)} \\
	P_m(t_i) = \frac{E_{active} + E_{idle}}{T_i} \\
	E_{active} = E_{sync} + P_{attach}\cdot T_{attach} + P_{transmit}\cdot T_{transmit} + E_{release} \\
	E_{idle} = \begin{cases} P_{DRX}\cdot T_{DRX} + P_{PSM}\cdot (T_i - T_{attach} - T_{transmit} - T_{DRX}) \quad \text{for PSM}\\
							P_{DRX}\cdot T_{PTW} + P_{PSM} \cdot (T_{PSM} - T_{PTW}) \qquad\qquad\qquad\quad\;\;\, \text{for eDRX}
				\end{cases}
\end{gathered}
\end{equation}

From \autoref{eq:bat_est} a couple of problems become visible. 
First is that the time to sync and release of the device from the system has not been taken into account. This however will only influence the estimation slightly as the time is essentially added to the idle time and only amounts to a few seconds. 
Second is that $E_{active}$ depends on two parameters, $P_{TX}$ and $T_{transmit}$. Measurements has been done to characterize $P_{TX}$ but not $T_{transmit}$, because $T_{transmit}$ depends not only on the amount of data the device wants to transmit, but also on some cell specific parameters such as repetition, TBS etc. It is used as a parameter here but future work should consider defining this in terms of it own parameters. 
The third problem is that $E_{idle}$ is depending on several things first is which idle mode is used second is what timer values are associated with the idle mode. Since this potentially has severe consequences for the power consumption the impact of this is also elaborated upon. 
The forth problem is also with the model used to estimate $E_{idle}$ for PSM mode it is assumed that timer defining when \gls{TAU} appears is always bigger than $T_i$ meaning that only when the device has data does it wake up from PSM and for eDRX the energy is calculated based on a complete cycle which might be interrupted by the data transmission, this issue become less relevant with larger $T_i$ and smaller $T_{PSM}$. 

A common factor for all these problems is the model will underestimate the battery lifetime except in the case of T3412 being larger than $T_i$, however as the assumptions made here helps simplify the model it is considered to be reasonable. Another important step in this regard is that for all the measured parameters a statistical analysis was made, based on this analysis values are chosen such that there is a 95\% confidence that the device will life for the estimated time or in other words such that at least 95\% of the values are below the chosen value. To start the analysis of the battery lifetime four cases are chosen for idle mode eDRX and PSM respectively, the values for these cases can be seen in \autoref{tab:case_description}. This is done to visualize the impact of the chosen mode and timer values, a case where only DRX is used is not considered as this should only be relevant for very low $T_i$'s and then it is covered by eDRX and PSM already.

\begin{table}[H]
\centering
\begin{tabular}{|c|c|c|c|c|c|c|} \hline
				& Idle mode & $T_{DRX}$	& $T_{PSM}$	& $T_{PTW}$	& $T_{Transmit}$	& $P_{TX}$ 	\\ \hline
\multirow{2}{*}{Case 1}	& eDRX & - 		& 20.48 s	& 5.12 s	& 1 s				& 20 dBm	\\ \cline{2-7}
						& PSM  & 2 s 	& -			& -			& 1 s				& 20 dBm	\\ \hline
\multirow{2}{*}{Case 2}	& eDRX & -		& 163.84 s	& 10.24 s	& 1 s				& 20 dBm	\\ \cline{2-7}
						& PSM  & 10 s	& -			& -			& 1 s				& 20 dBm	\\ \hline
\multirow{2}{*}{Case 3}	& eDRX & -		& 1310.72 s	& 20.48 s	& 1 s				& 20 dBm	\\ \cline{2-7}
						& PSM  & 50 s	& -			& -			& 1 s				& 20 dBm	\\ \hline
\multirow{2}{*}{Case 4}	& eDRX & -		& 10485.76 s& 40.96 s	& 1 s				& 20 dBm	\\ \cline{2-7}
						& PSM  & 250 s	& -			& -			& 1 s				& 20 dBm	\\ \hline
\end{tabular}
\caption{Timer settings for the four cases.}
\label{tab:case_description}
\end{table}

The expected battery lifetime for these four cases is found for different $T_i$'s as can be seen in \autoref{fig:eDRXvsPSM}.

\begin{figure}[H]
\centering
\tikzsetnextfilename{eDRXvsPSM}
\resizebox{0.7\textwidth}{!}{
\input{figures/QuectelMeas/eDRXvsPSM2.tex}}
\caption{Battery life time estimation for the four cases for different $T_i$'s. Full line using PSM, dashed line using eDRX.}
\label{fig:eDRXvsPSM}
\end{figure}

As can be seen in \autoref{fig:eDRXvsPSM} the longer the $T_i$ the more impactful the these parameters become which makes sense as more time is spent in idle mode. What is also interesting to note is that each case is going asymptotic towards certain values and that eDRX is more influenced by the timer values than PSM is. To give a more clear picture of the influence of the timer values the $T_i$ is set to 24 hours and the timer values are changed are varied according to the values found in \autoref{sec:Network_access} this can be seen in \autoref{fig:TimerPlot_plots}.


\begin{figure}[H]
\centering
\begin{minipage}{0.48\textwidth}
\tikzsetnextfilename{eDRX_each_day_TimerPlot}
\resizebox{\textwidth}{!}{
\input{figures/QuectelMeas/Scenario_2_TimerPlot.tex}}
\end{minipage}
\hfill
\begin{minipage}{0.48\textwidth}
\tikzsetnextfilename{PSM_each_day_TimerPlot}
\resizebox{\textwidth}{!}{
\input{figures/QuectelMeas/Scenario_4_TimerPlot.tex}}
\end{minipage}
\caption{Influence of timer settings for the estimated battery lifetime.}
\label{fig:TimerPlot_plots}
\end{figure}

From \autoref{fig:TimerPlot_plots} it can be seen that the values for the eDRX timers are very influential, as the expected lifetime is varying from 0.15 years to 17.34 years, where for PSM the lifetime only varies from 15.33 to 16.28 years. The next step is to look at the influence of $T_{transmit}$ and $P_{TX}$. To do this four scenarios are picked such that the differences for high and low $T_i$'s in each idle mode can be compared, the values chosen to showcase this can be seen in \autoref{tab:scenario_description}.


\begin{table}[H]
\centering
\begin{tabular}{|c|c|c|c|c|c|} \hline
			& $T_i$ 		& Idle mode	& $T_{DRX}$	& $T_{PSM}$	& $T_{PTW}$	\\ \hline
Scenario 1	& 1 hour 	& eDRX 		& -			& 10485.76 s& 10.24 s	\\ \hline
Scenario 2	& 24 hours 	& eDRX 		& -			& 10485.76 s& 10.24 s	\\ \hline
Scenario 3	& 1 hour 	& PSM		& 10 s		& -			& -			\\ \hline
Scenario 4	& 24 hours 	& PSM		& 10 s		& -			& -			\\ \hline
\end{tabular}
\caption{Parameter values chosen for each scenario.}
\label{tab:scenario_description}
\end{table}

For each of the four scenarios the transmit power and transmit time is varied independent of each other and the battery lifetime is estimated for each combination as seen in \autoref{fig:lifetime_plots}.


\begin{figure}[H]
\centering
\begin{minipage}{0.48\textwidth}
\tikzsetnextfilename{eDRX_each_hour_lifetime}
\resizebox{\textwidth}{!}{
\input{figures/QuectelMeas/Scenario_1_lifetime.tex}}
\end{minipage}
\hfill
\begin{minipage}{0.48\textwidth}
\tikzsetnextfilename{eDRX_each_day_lifetime}
\resizebox{\textwidth}{!}{
\input{figures/QuectelMeas/Scenario_2_lifetime.tex}}
\end{minipage}
\begin{minipage}{0.48\textwidth}
\tikzsetnextfilename{PSM_each_hour_lifetime}
\resizebox{\textwidth}{!}{
\input{figures/QuectelMeas/Scenario_3_lifetime.tex}}
\end{minipage}
\hfill
\begin{minipage}{0.48\textwidth}
\tikzsetnextfilename{PSM_each_day_lifetime}
\resizebox{\textwidth}{!}{
\input{figures/QuectelMeas/Scenario_4_lifetime.tex}}
\end{minipage}
\caption{The estimated battery lifetime for the mentioned scenarios with respect to transmit power and transmit duration.}
\label{fig:lifetime_plots}
\end{figure}

Here it can be seen again that the values of these parameters have a huge effect. Especially $T_{transmit}$ which alone can bring the lifetime down to less than a year no matter the other parameters. A realistic value for $T_{transmit}$ is not really known as it depends heavily on the usages as well as a multitude of cell parameters. To clarify the utilization of the energy spent four points has been picked out from each plot in \autoref{fig:lifetime_plots}. The values of each point can be seen in \autoref{tab:point_description}.

\begin{table}[H]
\centering
\begin{tabular}{|c|c|c|} \hline
& $T_{Transmit}$ & $P_{TX}$ \\ \hline
Point 1 & 100 ms& -20 dBm  	\\ \hline
Point 2 & 100 s	& -20 dBm  	\\ \hline
Point 3 & 100 ms& 23 dBm 	\\ \hline
Point 4 & 100 s	& 23 dBm 	\\ \hline
\end{tabular}
\caption{Points chosen to investigate.}
\label{tab:point_description}
\end{table} 

For each of the points in each of plots the energy usages has been divided up into five parts corresponding to the five elements in the model:  sync, attach, transmit, release and idle. The result of which can be seen in \autoref{fig:barplot_plots}.
 
\definecolor{mycolor1}{rgb}{0.00000,0.44700,0.74100}%
\definecolor{mycolor2}{rgb}{0.85000,0.32500,0.09800}%
\definecolor{mycolor3}{rgb}{0.92900,0.69400,0.12500}%
\definecolor{mycolor4}{rgb}{0.49400,0.18400,0.55600}%
\definecolor{mycolor5}{rgb}{0.46600,0.67400,0.18800}%
\begin{figure}[H]
\centering
\begin{minipage}{0.48\textwidth}
\tikzsetnextfilename{PSM_each_hour_barplot}
\resizebox{\textwidth}{!}{
\input{figures/QuectelMeas/Scenario_1_barplot.tex}}
\end{minipage}
\begin{minipage}{0.48\textwidth}
%Scenario 1
\begin{table}[H]
\centering
\resizebox{\textwidth}{!}{
\begin{tabular}{|c|c|c|c|c|} \hline
 & Pont 1	& Pont 2	& Pont 3	& Pont 4	\\ \hline
\cellcolor{mycolor5}Idle	& 4.6009\% 	& 0.8012\%	& 2.9499\%	& 0.0067\%\\ \hline
\cellcolor{mycolor4}Release	& 50.7850\% 	& 9.0970\%	& 32.5614\%	& 0.0763\%\\ \hline
\cellcolor{mycolor3}Transmit	& 0.0458\% 	& 82.1184\%	& 4.2587\%	& 99.7759\%\\ \hline
\cellcolor{mycolor2}Attach	& 44.5683\% 	& 7.9834\%	& 60.2301\%	& 0.1411\%\\ \hline
Lifetime (years)	& 2.1552 	& 0.3860	& 1.3818	& 0.0032\\ \hline
\end{tabular}}
\end{table}
\end{minipage}
\begin{minipage}{0.48\textwidth}
\tikzsetnextfilename{PSM_each_day_barplot}
\resizebox{\textwidth}{!}{
\input{figures/QuectelMeas/Scenario_2_barplot.tex}}
\end{minipage}
\hfill
\begin{minipage}{0.48\textwidth}
%Scenario 2
\begin{table}[H]
\centering
\resizebox{\textwidth}{!}{
\begin{tabular}{|c|c|c|c|c|} \hline
 & Pont 1	& Pont 2	& Pont 3	& Pont 4	\\ \hline
\cellcolor{mycolor5}Idle	& 53.6666\% 	& 16.6180\%	& 42.1967\%	& 0.1655\%\\ \hline
\cellcolor{mycolor4}Release	& 24.6652\% 	& 7.6465\%	& 19.3936\%	& 0.0762\%\\ \hline
\cellcolor{mycolor3}Transmit	& 0.0223\% 	& 69.0250\%	& 2.5365\%	& 99.6174\%\\ \hline
\cellcolor{mycolor2}Attach	& 21.6459\% 	& 6.7105\%	& 35.8732\%	& 0.1409\%\\ \hline
Lifetime (years)	& 25.1212 	& 7.7878	& 19.7521	& 0.0776\\ \hline
\end{tabular}}
\end{table}
\end{minipage}
\hfill
\begin{minipage}{0.48\textwidth}
\tikzsetnextfilename{eDRX_each_hour_barplot}
\resizebox{\textwidth}{!}{
\input{figures/QuectelMeas/Scenario_3_barplot.tex}}
\end{minipage}
\hfill
\begin{minipage}{0.48\textwidth}
%Scenario 3
\begin{table}[H]
\centering
\resizebox{\textwidth}{!}{
\begin{tabular}{|c|c|c|c|c|} \hline
 & Pont 1	& Pont 2	& Pont 3	& Pont 4	\\ \hline
\cellcolor{mycolor5}Idle	& 1.3897\% 	& 0.2812\%	& 0.9489\%	& 0.0024\%\\ \hline
\cellcolor{mycolor4}Release	& 42.1584\% 	& 8.7741\%	& 28.7849\%	& 0.0763\%\\ \hline
\cellcolor{mycolor3}Transmit	& 0.0381\% 	& 79.2038\%	& 3.7648\%	& 99.7451\%\\ \hline
\cellcolor{mycolor2}Attach	& 36.9977\% 	& 7.7000\%	& 53.2445\%	& 0.1411\%\\ \hline
\cellcolor{mycolor1}Sync	& 19.4162\% 	& 4.0409\%	& 13.2570\%	& 0.0351\%\\ \hline
Lifetime (years)	& 1.7891 	& 0.3723	& 1.2215	& 0.0032\\ \hline
\end{tabular}}
\end{table}
\end{minipage}
\begin{minipage}{0.48\textwidth}
\tikzsetnextfilename{eDRX_each_day_barplot}
\resizebox{\textwidth}{!}{
\input{figures/QuectelMeas/Scenario_4_barplot.tex}}
\end{minipage}
\hfill
\begin{minipage}{0.48\textwidth}
%Scenario 4
\begin{table}[H]
\centering
\resizebox{\textwidth}{!}{
\begin{tabular}{|c|c|c|c|c|} \hline
 & Pont 1	& Pont 2	& Pont 3	& Pont 4	\\ \hline
\cellcolor{mycolor5}Idle	& 25.2881\% 	& 6.5054\%	& 18.7042\%	& 0.0603\%\\ \hline
\cellcolor{mycolor4}Release	& 31.9412\% 	& 8.2264\%	& 23.6251\%	& 0.0762\%\\ \hline
\cellcolor{mycolor3}Transmit	& 0.0288\% 	& 74.2601\%	& 3.0899\%	& 99.6874\%\\ \hline
\cellcolor{mycolor2}Attach	& 28.0312\% 	& 7.2194\%	& 43.7002\%	& 0.1410\%\\ \hline
\cellcolor{mycolor1}Sync	& 14.7106\% 	& 3.7887\%	& 10.8806\%	& 0.0351\%\\ \hline
Lifetime (years)	& 32.5317 	& 8.3785	& 24.0618	& 0.0776\\ \hline
\end{tabular}}
\end{table}
\end{minipage}
\caption{The distribution of power for each phase of a cycle. Blue is the sync phase, red is the attach phase, yellow is the transmit phase, purple is the release phase and green is the idle phase.}
\label{fig:barplot_plots}
\end{figure}

It can be seen that depending on the point and scenario the energy is used quite differently, however some commonalities can be seen. For instance if each transmission is 100 s more than 69\% of the energy is spent during the transmit phase if $P_{TX}$ is also high then more than 99\% of the energy is spent here. Another point is that with a low $T_i$, $E_{idle}$ take op less than 5\% of the used energy, while for a high $T_i$ it can take up 53\% of the energy. As mentioned when finding the energy to release the device from the network, the model fails to predict how it scales with $P_{TX}$ and a 95\% limit was taken as a worst case estimate. This shows here as the energy spent during the attach phase is actually less than that used during the release phase when $P_{TX}$ is set low, which in reality should not be the case. It can also be seen here why a low $T_i$ makes eDRX more feasible than PSM, as the energy spent to synchronize is fairly high, while for high $T_i$ the energy spent on paging will be even higher. Another thing to take from this is also that even with a $T_i$ of 24 hours if maximum $P_{TX}$ is used, $T_{transmit}$ should be less than 0.4677 s and 0.4571 s for eDRX and PSM respectively to get a battery lifetime of 10 years. 


With this analysis it can be concluded that a device can achieve a battery lifetime of more than 10 years, but in extreme situations the repetition value will increase which makes $T_{transmit}$ increase, and also the needed $P_{TX}$ would be high. When these parameters are high it has been shown that a battery lifetime might not even exceed one year independently on all other parameters. To combat this when designing the devices, focus should be put on decreasing $T_{transmit}$ as much as possible, and also on increasing $T_i$. 
